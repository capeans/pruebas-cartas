<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tu carrito</title>
</head>
<body style="font-family:sans-serif;max-width:900px;margin:20px auto;padding:16px;">
  <header style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
    <h1>Carrito</h1>
    <nav>
      <a href="index.html" style="margin-right:16px;">Seguir comprando</a>
      <a href="#" onclick="logout();return false;">Salir</a>
    </nav>
  </header>

  <section id="cart-list"></section>

  <div style="display:flex;justify-content:flex-end;margin-top:20px;gap:20px;align-items:center;">
    <div style="font-size:18px;">
      Total: <span id="cart-total">0 €</span>
    </div>
    <button id="checkout-btn" style="padding:10px 16px;background:#222;color:#fff;border:none;border-radius:6px;cursor:pointer;">
      Finalizar compra
    </button>
  </div>

  <p id="cart-empty" style="text-align:center;color:#666;margin-top:40px;display:none;">
    Tu carrito está vacío.
  </p>

  <script src="js/api.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/cart.js"></script>
  <script>
    async function renderCart() {
      const detail = await getCartDetail();

      const container = document.getElementById("cart-list");
      const totalEl = document.getElementById("cart-total");
      const emptyEl = document.getElementById("cart-empty");

      container.innerHTML = "";
      let totalCents = 0;

      if (!detail || detail.length === 0) {
        emptyEl.style.display = "block";
        totalEl.textContent = "0 €";
        return;
      } else {
        emptyEl.style.display = "none";
      }

      detail.forEach(item => {
        totalCents += item.subtotalCents;
        const div = document.createElement("div");
        div.style.border = "1px solid #ddd";
        div.style.borderRadius = "8px";
        div.style.display = "flex";
        div.style.justifyContent = "space-between";
        div.style.alignItems = "flex-start";
        div.style.padding = "12px 16px";
        div.style.marginBottom = "12px";

        div.innerHTML = `
          <div style="display:flex;gap:12px;">
            <img src="${item.imageUrl}" style="width:80px;height:80px;object-fit:cover;border-radius:6px;"/>
            <div>
              <div style="font-weight:600;">${item.name}</div>
              <div style="font-size:14px;color:#666;">Precio: ${(item.priceCents/100).toFixed(2)} €</div>
              <div style="font-size:14px;color:#666;">Subtotal: ${(item.subtotalCents/100).toFixed(2)} €</div>
            </div>
          </div>
          <div style="text-align:right;">
            <label style="font-size:14px;color:#444;">Cantidad</label><br/>
            <input data-id="${item.productId}" class="qty-input" type="number" min="1" value="${item.qty}"
              style="width:60px;padding:6px;border:1px solid #ccc;border-radius:4px;"/>
            <button data-id="${item.productId}" class="rm-btn"
              style="display:block;background:none;border:none;color:#c00;font-size:13px;margin-top:8px;cursor:pointer;">
              Quitar
            </button>
          </div>
        `;
        container.appendChild(div);
      });

      totalEl.textContent = (totalCents/100).toFixed(2) + " €";

      document.querySelectorAll(".qty-input").forEach(inp => {
        inp.addEventListener("change", async () => {
          const id = parseInt(inp.dataset.id,10);
          const val = parseInt(inp.value,10);
          await setCartQty(id, val);
          renderCart();
        })
      });

      document.querySelectorAll(".rm-btn").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = parseInt(btn.dataset.id,10);
          await removeCartItem(id);
          renderCart();
        })
      });
    }

    document.getElementById("checkout-btn").addEventListener("click", () => {
      if (!isLoggedIn()) {
        window.location.href = "login.html";
      } else {
        window.location.href = "checkout.html";
      }
    });

    renderCart();
  </script>
</body>
</html>
